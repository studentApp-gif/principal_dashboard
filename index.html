<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Principal Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{
      font-family: Arial, sans-serif;
      background:#f7f7f7;
      margin:0;
      padding:0;
    }
    header{
      background:#005baa;
      color:#fff;
      padding:18px;
      text-align:center;
      font-size:1.6rem;
    }
    .container{
      display:grid;
      grid-template-columns: repeat(auto-fit,minmax(350px,1fr));
      gap:20px;
      padding:25px;
    }
    .card{
      background:white;
      padding:20px;
      border-radius:12px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }
    canvas{
      width:100% !important;
      height:300px !important;
    }
  </style>
</head>
<body>

<header>Principal Dashboard – Students Attendance</header>

<div class="container">
  <div class="card">
    <h3>CSM</h3>
    <canvas id="csmChart"></canvas>
  </div>
  <div class="card">
    <h3>CSE</h3>
    <canvas id="cseChart"></canvas>
  </div>
  <div class="card">
    <h3>ECE</h3>
    <canvas id="eceChart"></canvas>
  </div>
  <div class="card">
    <h3>HS</h3>
    <canvas id="hsChart"></canvas>
  </div>
</div>

<script>
const apiURL = 'https://script.google.com/macros/s/YOUR_DEPLOY_ID/exec'; // <- change to your WebApp

async function loadData(){
  try{
    const res = await fetch(apiURL);
    const data = await res.json();
    // data = { CSM:[{year:'II',total:40,present:35},...], CSE:[...], ... }
    buildCharts(data);
  }catch(e){
    console.error('Data load error',e);
  }
}

function buildCharts(allData){
  const colors = ['#4285F4','#DB4437','#F4B400','#0F9D58','#AB47BC'];
  const createChart = (ctx,dept)=>{
    const deptData = allData[dept];
    if(!deptData) return;

    const labels = deptData.map(x=>x.year);
    const totals = deptData.map(x=>x.total);
    const presents = deptData.map(x=>x.present);
    const percent = presents.map((p,i)=>((p/totals[i])*100).toFixed(2));

    new Chart(ctx,{
      type:'pie',
      data:{
        labels: labels,
        datasets:[{
          label:'Present',
          data: percent,
          backgroundColor: colors.slice(0,labels.length),
          borderWidth:1
        }]
      },
      options:{
        responsive:true,
        plugins:{
          tooltip:{
            callbacks:{
              label:(item)=>{
                const yr = labels[item.dataIndex];
                return `${yr}: ${presents[item.dataIndex]} / ${totals[item.dataIndex]} (${percent[item.dataIndex]}%)`;
              }
            }
          },
          legend:{
            position:'bottom',
            labels:{
              generateLabels:(chart)=>{
                const ds = chart.data.datasets[0];
                return chart.data.labels.map((label,i)=>({
                  text:`${label} – ${percent[i]}%`,
                  fillStyle: ds.backgroundColor[i],
                  strokeStyle:'#fff',
                  lineWidth:2,
                  hidden: false,
                  index: i
                }));
              }
            }
          }
        }
      }
    });
  };

  createChart(document.getElementById('csmChart'),'CSM');
  createChart(document.getElementById('cseChart'),'CSE');
  createChart(document.getElementById('eceChart'),'ECE');
  createChart(document.getElementById('hsChart'),'HS');
}

loadData();
</script>

</body>
</html>
