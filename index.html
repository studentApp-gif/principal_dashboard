<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Principal Attendance Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<style>
body{
  font-family: Arial;
  background:#f7f7f7;
  margin:0;
}

header{
  background:#004d80;
  color:white;
  padding:15px;
  text-align:center;
  font-size:1.5rem;
}

.controls{
  background:white;
  max-width:950px;
  margin:20px auto;
  padding:15px;
  border-radius:8px;
  display:flex;
  gap:15px;
  justify-content:center;
  flex-wrap:wrap;
}

select,input{
  padding:8px;
  font-size:1rem;
}

button{
  padding:8px 15px;
  background:#004d80;
  color:white;
  border:none;
  border-radius:5px;
  cursor:pointer;
}

button:hover{
  background:#00345a;
}

.dept-block{
  background:white;
  margin:25px auto;
  padding:20px;
  max-width:950px;
  border-radius:8px;
  box-shadow:0 2px 5px rgba(0,0,0,.1);
}

.row{
  display:flex;
  flex-wrap:wrap;
  gap:20px;
  align-items:center;
  justify-content:space-between;
}

.info{
  flex:1 1 55%;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}

th,td{
  padding:8px;
  border:1px solid #ddd;
  text-align:center;
}

th{
  background:#004d80;
  color:white;
}

canvas{
  max-width:350px;
  height:350px !important;
}

.present-count{
  color:green;
  font-weight:bold;
}

.error{
  color:red;
  text-align:center;
  font-weight:bold;
}
</style>
</head>

<body>

<header>
SVCE Principal Attendance Review Dashboard
</header>

<div class="controls">
<label>
Date:
<input type="date" id="dateSelect">
</label>

<label>
Session:
<select id="sessionSelect">
<option value="Morning">Morning</option>
<option value="Afternoon">Afternoon</option>
</select>
</label>

<button onclick="loadDashboard()">Load Report</button>
</div>

<div id="content">Select date and session</div>

<script>

const SCRIPT_URL="https://script.google.com/macros/s/AKfycbwnwn20CSLQrT55Kfyw_CoBM2PipoNMzbEPpVDocuMBF1zn81LLuEYNxuS0-X95XU5t/exec";
const charts=[];

document.addEventListener("DOMContentLoaded",()=>{
  document.getElementById("dateSelect").value=
  new Date().toISOString().split("T")[0];
});

async function loadDashboard(){

  const container=document.getElementById("content");
  const date=document.getElementById("dateSelect").value;
  const session=document.getElementById("sessionSelect").value;

  container.innerHTML="Loading dashboard...";
  charts.forEach(c=>c.destroy());
  charts.length=0;

  try{

    const res=await fetch(
      `${SCRIPT_URL}?action=getPrincipalSummary&date=${date}&session=${session}`
    );

    const json=await res.json();

    if(!json.success){
      container.innerHTML=`<p class="error">${json.message}</p>`;
      return;
    }

    const data=json.data;

    if(!data || Object.keys(data).length===0){
      container.innerHTML="<p class='error'>No attendance found</p>";
      return;
    }

    container.innerHTML="";
    const deptMap={};

    Object.keys(data).forEach(k=>{
      const [dept,year]=k.split("|");
      if(!deptMap[dept]) deptMap[dept]={};
      deptMap[dept][year]=data[k];
    });

    Object.keys(deptMap).forEach(dept=>{

      const yearsData=deptMap[dept];
      const block=document.createElement("div");
      block.className="dept-block";
      block.innerHTML=`<h2>${dept} Department (${session})</h2>`;

      const labels=[],perc=[],years=[];
      const totals=[],presents=[],boysP=[],girlsP=[];

      Object.keys(yearsData).forEach(year=>{
        const st=yearsData[year];
        years.push(year);
        labels.push(`${year} Year`);
        totals.push(st.total);
        presents.push(st.present);
        boysP.push(st.boysPresent);
        girlsP.push(st.girlsPresent);
        perc.push(st.total ? ((st.present/st.total)*100).toFixed(1) : 0);
      });

      let table=`<table>
      <thead>
      <tr>
        <th>Year</th>
        <th>Total</th>
        <th>Present</th>
        <th>Boys</th>
        <th>Girls</th>
        <th>%</th>
      </tr>
      </thead><tbody>`;

      labels.forEach((y,i)=>{
        table+=`<tr>
          <td>${y}</td>
          <td>${totals[i]}</td>
          <td class="present-count">${presents[i]}</td>
          <td>${boysP[i]}</td>
          <td>${girlsP[i]}</td>
          <td>${perc[i]}%</td>
        </tr>`;
      });

      table+="</tbody></table>";

      const row=document.createElement("div");
      row.className="row";

      const info=document.createElement("div");
      info.className="info";
      info.innerHTML=table;

      const chartWrap=document.createElement("div");
      const canvas=document.createElement("canvas");
      chartWrap.appendChild(canvas);

      row.appendChild(info);
      row.appendChild(chartWrap);
      block.appendChild(row);
      container.appendChild(block);

      const chart=new Chart(canvas,{
        type:"pie",
        data:{
          labels:labels.map((l,i)=>`${l} (${perc[i]}%)`),
          datasets:[{
            data:perc,
            backgroundColor:[
              "#42a5f5","#66bb6a","#ffa726",
              "#ef5350","#ab47bc","#29b6f6"
            ]
          }]
        },
        options:{
          plugins:{
            legend:{position:"bottom"},
            datalabels:{
              color:"#fff",
              formatter:(v,ctx)=>`${years[ctx.dataIndex]} Year\n${v}%`,
              font:{weight:"bold"}
            }
          }
        },
        plugins:[ChartDataLabels]
      });

      charts.push(chart);
    });

  }catch(err){
    container.innerHTML=`<p class="error">${err.message}</p>`;
  }
}
</script>

</body>
</html>
