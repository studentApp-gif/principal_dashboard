<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title> SVCE  PRINCIPAL DASHBOARD </title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<style>

body{
  font-family: Arial, Helvetica, sans-serif;
  background:#f0f2f5;
  margin:0;
}

/* ===== HEADER ===== */
header{
  background:#0f4c75;
  color:white;
  padding:15px;
  text-align:center;
  font-size:1.4rem;
  font-weight:bold;
}

/* ===== CONTROLS ===== */
.controls{
  background:#e9ecef;
  padding:15px;
  text-align:center;
}

.controls label{
  margin:0 10px;
  font-weight:bold;
}

select,input{
  padding:6px;
  margin-left:5px;
}

button{
  padding:6px 12px;
  background:#c9c9c9;
  border:1px solid #999;
  cursor:pointer;
}

button:hover{
  background:#b5b5b5;
}

/* ===== DEPARTMENT BLOCK ===== */
.dept-block{
  background:white;
  margin:25px auto;
  padding:25px;
  max-width:950px;
  border-radius:8px;
  box-shadow:0 3px 8px rgba(0,0,0,0.08);
}

/* ===== TABLE ===== */
table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}

th{
  background:#0f4c75;
  color:white;
  padding:8px;
  border:1px solid #ddd;
}

td{
  padding:8px;
  border:1px solid #ddd;
  text-align:center;
}

.present-count{
  color:green;
  font-weight:bold;
}

/* ===== LAYOUT ROW ===== */
.row{
  display:flex;
  flex-wrap:wrap;
  gap:20px;
  align-items:center;
  justify-content:space-between;
}

.info{
  flex:1 1 55%;
}

canvas{
  max-width:320px;
}

.error{
  color:red;
  text-align:center;
  font-weight:bold;
  margin-top:20px;
}

</style>
</head>

<body>

<header>
SVCE STUDENT ATTENDANCE REVIEW DASHBOARD<BR> (PRINCIPAL DASHBOARD)
</header>

<div class="controls">

<label>
Date:
<input type="date" id="dateSelect">
</label>

<label>
Session:
<select id="sessionSelect">
<option value="Morning">Morning</option>
<option value="Afternoon">Afternoon</option>
</select>
</label>

<button onclick="loadDashboard()">Load Report</button>

</div>

<div id="content" style="text-align:center; margin-top:20px;">
Select date and session
</div>

<script>

const SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbwnwn20CSLQrT55Kfyw_CoBM2PipoNMzbEPpVDocuMBF1zn81LLuEYNxuS0-X95XU5t/exec";

const charts=[];

/* Auto set today's date */
document.addEventListener("DOMContentLoaded",()=>{
  document.getElementById("dateSelect").value =
    new Date().toISOString().split("T")[0];
});

/* ===== LOAD DASHBOARD ===== */
async function loadDashboard(){

  const container=document.getElementById("content");
  const date=document.getElementById("dateSelect").value;
  const session=document.getElementById("sessionSelect").value;

  container.innerHTML="Loading attendance...";

  charts.forEach(c=>c.destroy());
  charts.length=0;

  try{

    const res=await fetch(
      `${SCRIPT_URL}?action=getPrincipalSummary&date=${date}&session=${session}`
    );

    const json=await res.json();

    if(!json.success){
      container.innerHTML=`<p class="error">${json.message}</p>`;
      return;
    }

    const data=json.data;

    if(!data || Object.keys(data).length===0){
      container.innerHTML="<p class='error'>No attendance found</p>";
      return;
    }

    container.innerHTML="";

    /* GROUP BY DEPT */
    const deptMap={};

    Object.keys(data).forEach(k=>{
      const [dept,year]=k.split("-");
      if(!deptMap[dept]) deptMap[dept]={};
      deptMap[dept][year]=data[k];
    });

    /* BUILD UI */
    Object.keys(deptMap).forEach(dept=>{

      const yearsData=deptMap[dept];

      const block=document.createElement("div");
      block.className="dept-block";
      block.innerHTML=`<h2>${dept} Department (${session})</h2>`;

      const labels=[],perc=[],years=[];
      const totals=[],presents=[];
      const boysP=[],girlsP=[];

      Object.keys(yearsData).forEach(year=>{

        const st=yearsData[year];

        years.push(year);
        labels.push(`${year} Year`);

        totals.push(st.total);
        presents.push(st.present);
        boysP.push(st.boysPresent);
        girlsP.push(st.girlsPresent);

        perc.push(
          st.total ? ((st.present/st.total)*100).toFixed(1) : 0
        );
      });

      /* TABLE */
      let table=`
      <table>
      <thead>
      <tr>
        <th>Year</th>
        <th>Total Students</th>
        <th>Present</th>
        <th>Boys (P)</th>
        <th>Girls (P)</th>
        <th>%</th>
      </tr>
      </thead>
      <tbody>
      `;

      labels.forEach((y,i)=>{
        table+=`
        <tr>
          <td>${y}</td>
          <td>${totals[i]}</td>
          <td class="present-count">${presents[i]}</td>
          <td>${boysP[i]}</td>
          <td>${girlsP[i]}</td>
          <td>${perc[i]}%</td>
        </tr>`;
      });

      table+="</tbody></table>";

      const row=document.createElement("div");
      row.className="row";

      const info=document.createElement("div");
      info.className="info";
      info.innerHTML=table;

      const chartWrap=document.createElement("div");
      const canvas=document.createElement("canvas");
      chartWrap.appendChild(canvas);

      row.appendChild(info);
      row.appendChild(chartWrap);

      block.appendChild(row);
      container.appendChild(block);

      /* PIE CHART */
      const chart=new Chart(canvas,{
        type:"pie",
        data:{
          labels:labels.map((l,i)=>`${l} (${perc[i]}%)`),
          datasets:[{
            data:perc,
            backgroundColor:[
              "#42a5f5","#66bb6a","#ffa726",
              "#ef5350","#ab47bc","#29b6f6"
            ]
          }]
        },
        options:{
          plugins:{
            legend:{position:"bottom"},
            datalabels:{
              color:"#fff",
              formatter:(v,ctx)=>`${years[ctx.dataIndex]} Year\n${v}%`,
              font:{weight:"bold"}
            }
          }
        },
        plugins:[ChartDataLabels]
      });

      charts.push(chart);

    });

  }catch(err){
    container.innerHTML=`<p class="error">${err.message}</p>`;
  }
}

</script>

</body>
</html>

