<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Principal Attendance Dashboard | SVCE Kadapa</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<style>

body{
font-family:Arial;
background:#f7f7f7;
margin:0;
}

header{
background:#004d80;
color:white;
padding:15px;
text-align:center;
font-size:1.5rem;
}

/* Controls */
.controls{
background:#fff;
max-width:950px;
margin:20px auto;
padding:15px;
border-radius:8px;
display:flex;
gap:15px;
justify-content:center;
flex-wrap:wrap;
}

select,input{
padding:8px;
font-size:1rem;
}

/* Dept Blocks */
.dept-block{
background:#fff;
margin:25px auto;
padding:20px;
max-width:950px;
border-radius:8px;
box-shadow:0 2px 5px rgba(0,0,0,.1);
}

h2{
margin-top:0;
color:#004d80;
}

.row{
display:flex;
flex-wrap:wrap;
align-items:center;
justify-content:space-between;
gap:20px;
}

.info{
flex:1 1 55%;
}

table{
width:100%;
border-collapse:collapse;
margin-top:10px;
}

th,td{
padding:6px 8px;
border:1px solid #ddd;
text-align:center;
}

th{
background:#004d80;
color:#fff;
}

canvas{
width:100%;
max-width:350px;
height:350px !important;
}

.error{
color:red;
text-align:center;
margin-top:20px;
font-weight:bold;
}

.present-count{
color:green;
font-weight:bold;
}

</style>
</head>

<body>

<header>
Principal Attendance Dashboard | SVCE Kadapa
</header>

<!-- Controls -->
<div class="controls">

<label>
Date:
<input type="date" id="dateSelect">
</label>

<label>
Session:
<select id="sessionSelect">
<option value="Morning">Morning</option>
<option value="Afternoon">Afternoon</option>
</select>
</label>

<button onclick="loadDashboard()">Load Report</button>

</div>

<div id="content">Select date and session</div>

<script>

/* ========= CONFIG ========= */

const SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbwnwn20CSLQrT55Kfyw_CoBM2PipoNMzbEPpVDocuMBF1zn81LLuEYNxuS0-X95XU5t/exec";

let charts=[];

/* Default today's date */
document.addEventListener("DOMContentLoaded",()=>{
document.getElementById("dateSelect").value =
new Date().toISOString().split("T")[0];
});


/* ========= LOAD DASHBOARD ========= */

async function loadDashboard(){

const container = document.getElementById("content");

const date = document.getElementById("dateSelect").value;
const session = document.getElementById("sessionSelect").value;

container.innerHTML="Loading dashboard...";

/* Destroy old charts */
charts.forEach(c=>c.destroy());
charts=[];

try{

const res = await fetch(
`${SCRIPT_URL}?action=getPrincipalSummary&date=${date}&session=${session}`
);

const json = await res.json();

if(!json.success){
container.innerHTML=`<p class="error">${json.message}</p>`;
return;
}

const data = json.data;

if(!data || Object.keys(data).length===0){
container.innerHTML="<p class='error'>No attendance found</p>";
return;
}

container.innerHTML="";

/* ===== GROUP BY DEPARTMENT ===== */

const deptMap={};

Object.keys(data).forEach(key=>{

const [dept,year] = key.split("-");

if(!deptMap[dept]) deptMap[dept]={};

deptMap[dept][year] = data[key];

});


/* ===== BUILD UI ===== */

Object.keys(deptMap).forEach(dept=>{

const yearsData = deptMap[dept];

const block = document.createElement("div");
block.className="dept-block";

block.innerHTML =
`<h2>${dept} Department (${session})</h2>`;


/* Arrays for chart */
const labels=[];
const perc=[];
const years=[];

const totals=[];
const presents=[];
const boysP=[];
const girlsP=[];


/* Process Year Data */

Object.keys(yearsData).sort().forEach(year=>{

const st = yearsData[year];

years.push(year);
labels.push(`${year} Year`);

totals.push(st.total || 0);
presents.push(st.present || 0);
boysP.push(st.boysPresent || 0);
girlsP.push(st.girlsPresent || 0);

const percentage =
st.total ? ((st.present/st.total)*100).toFixed(1) : 0;

perc.push(percentage);

});


/* ===== TABLE ===== */

let table=`<table>
<thead>
<tr>
<th>Year</th>
<th>Total</th>
<th>Present</th>
<th>Boys (P)</th>
<th>Girls (P)</th>
</tr>
</thead><tbody>`;

labels.forEach((y,i)=>{
table+=`
<tr>
<td>${y}</td>
<td>${totals[i]}</td>
<td class="present-count">${presents[i]}</td>
<td class="present-count">${boysP[i]}</td>
<td class="present-count">${girlsP[i]}</td>
</tr>`;
});

table+="</tbody></table>";

const row=document.createElement("div");
row.className="row";

const info=document.createElement("div");
info.className="info";
info.innerHTML=table;

const chartWrap=document.createElement("div");
const canvas=document.createElement("canvas");

chartWrap.appendChild(canvas);

row.appendChild(info);
row.appendChild(chartWrap);

block.appendChild(row);
container.appendChild(block);


/* ===== PIE CHART ===== */

const chart = new Chart(canvas,{
type:"pie",
data:{
labels:labels.map((l,i)=>`${l} (${perc[i]}%)`),
datasets:[{
data:perc,
backgroundColor:[
"#42a5f5",
"#66bb6a",
"#ffa726",
"#ef5350",
"#ab47bc",
"#29b6f6"
]
}]
},
options:{
plugins:{
legend:{position:"bottom"},
datalabels:{
color:"#fff",
formatter:(v,ctx)=>`${years[ctx.dataIndex]} Year\n${v}%`,
font:{weight:"bold",size:13}
}
}
},
plugins:[ChartDataLabels]
});

charts.push(chart);

});

}catch(err){

container.innerHTML=`<p class="error">${err.message}</p>`;

}

}

</script>

</body>
</html>
