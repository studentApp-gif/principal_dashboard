<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Principal Attendance Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>

body{
  font-family: Arial;
  background:#f7f7f7;
  margin:0;
}

header{
  background:#004d80;
  color:white;
  padding:15px;
  text-align:center;
  font-size:1.5rem;
}

.controls{
  background:white;
  max-width:900px;
  margin:20px auto;
  padding:15px;
  border-radius:8px;
  display:flex;
  gap:15px;
  justify-content:center;
  flex-wrap:wrap;
}

select,input,button{
  padding:8px;
  font-size:1rem;
}

button{
  background:#337ab7;
  color:white;
  border:none;
  cursor:pointer;
}

button:hover{
  background:#23527c;
}

.dept-block{
  background:white;
  margin:20px auto;
  padding:20px;
  max-width:900px;
  border-radius:8px;
  box-shadow:0 2px 5px rgba(0,0,0,.1);
}

h2{
  margin-top:0;
  color:#004d80;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}

th,td{
  border:1px solid #ddd;
  padding:8px;
  text-align:center;
}

th{
  background:#004d80;
  color:white;
}

.present{
  color:green;
  font-weight:bold;
}

.error{
  color:red;
  text-align:center;
  font-weight:bold;
}

.summary-box{
  background:#e8f4ff;
  padding:10px;
  border-radius:6px;
  margin-top:10px;
  text-align:center;
  font-weight:bold;
}

</style>
</head>

<body>

<header>
Principal Attendance Dashboard
</header>

<div class="controls">

<label>
Date:
<input type="date" id="dateSelect">
</label>

<label>
Session:
<select id="sessionSelect">
<option value="Morning">Morning</option>
<option value="Afternoon">Afternoon</option>
</select>
</label>

<button onclick="loadDashboard()">Load Report</button>

</div>

<div id="content">Select date and session</div>

<script>

const SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbwnwn20CSLQrT55Kfyw_CoBM2PipoNMzbEPpVDocuMBF1zn81LLuEYNxuS0-X95XU5t/exec";


/* Auto set today date */
document.addEventListener("DOMContentLoaded",()=>{
  document.getElementById("dateSelect").value =
    new Date().toISOString().split("T")[0];
});


/* ===== LOAD PRINCIPAL DASHBOARD ===== */

async function loadDashboard(){

  const container = document.getElementById("content");
  const date = document.getElementById("dateSelect").value;
  const session = document.getElementById("sessionSelect").value;

  container.innerHTML = "Loading attendance...";

  try{

    const res = await fetch(
      `${SCRIPT_URL}?action=getAttendanceByDate&date=${date}&session=${session}`
    );

    const json = await res.json();

    if(!json.success){
      container.innerHTML = `<p class="error">${json.message}</p>`;
      return;
    }

    const data = json.data;

    if(!data || data.length === 0){
      container.innerHTML = "<p class='error'>No attendance found</p>";
      return;
    }

    container.innerHTML = "";

    /* GROUP DATA DEPT + YEAR */
    const grouped = {};

    let grandTotal = 0;
    let grandPresent = 0;

    data.forEach(r => {

      if(!grouped[r.dept]) grouped[r.dept] = {};
      grouped[r.dept][r.year] = r;

      const boys = Number(r.boys || 0);
      const girls = Number(r.girls || 0);

      grandPresent += boys + girls;
      grandTotal++;

    });


    /* DISPLAY EACH DEPARTMENT */
    Object.keys(grouped).forEach(dept => {

      const block = document.createElement("div");
      block.className = "dept-block";

      block.innerHTML = `<h2>${dept} Department (${session})</h2>`;

      let deptPresent = 0;

      let table = `
        <table>
        <thead>
        <tr>
          <th>Year</th>
          <th>Boys Present</th>
          <th>Girls Present</th>
          <th>Total Present</th>
        </tr>
        </thead>
        <tbody>
      `;

      Object.keys(grouped[dept]).forEach(year => {

        const rec = grouped[dept][year];

        const boys = Number(rec.boys || 0);
        const girls = Number(rec.girls || 0);
        const total = boys + girls;

        deptPresent += total;

        table += `
          <tr>
            <td>${year} Year</td>
            <td class="present">${boys}</td>
            <td class="present">${girls}</td>
            <td class="present">${total}</td>
          </tr>
        `;

      });

      table += "</tbody></table>";

      block.innerHTML += table;

      block.innerHTML += `
        <div class="summary-box">
          Department Total Present : ${deptPresent}
        </div>
      `;

      container.appendChild(block);

    });


    /* GRAND SUMMARY */
    const summary = document.createElement("div");
    summary.className = "dept-block";

    summary.innerHTML = `
      <h2>Overall College Summary</h2>
      <div class="summary-box">
        Total Present Students : ${grandPresent}
      </div>
    `;

    container.appendChild(summary);

  }catch(err){

    container.innerHTML = `<p class="error">${err.message}</p>`;

  }

}

</script>

</body>
</html>
